name: RustDesk PRO Remote Desktop

on:
  workflow_dispatch:

jobs:
  pro-remote:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:

      - name: Show Windows Info
        run: |
          echo "Windows Version:"
          systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

      - name: Download RustDesk
        run: |
          Invoke-WebRequest `
            -Uri "https://github.com/rustdesk/rustdesk/releases/latest/download/rustdesk.exe" `
            -OutFile "C:\rustdesk.exe"

      - name: Create RustDesk Config Directory
        run: |
          New-Item -ItemType Directory -Force -Path "C:\ProgramData\RustDesk\config"

      - name: Configure Private RustDesk Server
        run: |
          $config = @"
{
  "id_server": "${{ secrets.RD_SERVER_IP }}",
  "relay_server": "${{ secrets.RD_SERVER_IP }}",
  "api_server": "${{ secrets.RD_SERVER_IP }}",
  "api_port": 21114,
  "relay_port": ${{ secrets.RD_RELAY_PORT }},
  "custom_rendezvous_server": "${{ secrets.RD_SERVER_IP }}:${{ secrets.RD_RENDEZVOUS_PORT }}"
}
"@

          $config | Out-File "C:\ProgramData\RustDesk\config\config.json" -Encoding UTF8

      - name: Generate Password
        run: |
          $pw = -join ((48..57)+(65..90)+(97..122) | Get-Random -Count 12 | % {[char]$_})
          Set-Content -Path "C:\ProgramData\RustDesk\config\password.txt" -Value $pw
          echo "RD_PASSWORD=$pw" >> $env:GITHUB_ENV
          Write-Host "Password Generated: $pw"

      - name: Start RustDesk Service
        run: |
          Start-Process "C:\rustdesk.exe" -ArgumentList "--service install" -Wait
          Start-Process "C:\rustdesk.exe" -ArgumentList "--service start" -Wait
          Start-Sleep -Seconds 5

      - name: Read RustDesk ID
        run: |
          Start-Sleep -Seconds 4
          $idFile = "C:\ProgramData\RustDesk\config\id_ed25519.pub"
          $id = Get-Content $idFile
          echo "RD_ID=$id" >> $env:GITHUB_ENV

          Write-Host "===== RUSTDESK PRO CONNECTION ====="
          Write-Host "ID:"
          Write-Host $id
          Write-Host "Password: $env:RD_PASSWORD"
          Write-Host "==================================="

      - name: Keep Alive
        run: |
          Write-Host "===== Remote Desktop Ready ====="
          Write-Host "RustDesk ID: $env:RD_ID"
          Write-Host "Password: $env:RD_PASSWORD"
          Write-Host "================================"
          while ($true) {
            Write-Host "[$(Get-Date)] Desktop Active..."
            Start-Sleep -Seconds 300
          }
