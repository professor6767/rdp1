name: RustDesk Remote Desktop

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:

      - name: Download RustDesk
        run: |
          Invoke-WebRequest -Uri "https://github.com/rustdesk/rustdesk/releases/latest/download/rustdesk.exe" -OutFile "C:\rustdesk.exe"

      - name: Create Config Folder
        run: |
          New-Item -ItemType Directory -Force -Path "C:\ProgramData\RustDesk\config"

      - name: Set Password
        run: |
          $pw = -join ((48..57)+(65..90)+(97..122) | Get-Random -Count 12 | % {[char]$_})
          Set-Content -Path "C:\ProgramData\RustDesk\config\password.txt" -Value $pw
          echo "PASSWORD=$pw" >> $env:GITHUB_ENV

      - name: Start RustDesk Service
        run: |
          Start-Process "C:\rustdesk.exe" -ArgumentList "--service install" -Wait
          Start-Process "C:\rustdesk.exe" -ArgumentList "--service start" -Wait
          Start-Sleep -Seconds 4

      - name: Get RustDesk ID
        run: |
          Start-Sleep -Seconds 4
          $id = Get-Content "C:\ProgramData\RustDesk\config\id_ed25519.pub"
          echo "ID=$id" >> $env:GITHUB_ENV
          Write-Host "RustDesk ID: $id"
          Write-Host "Password: $env:PASSWORD"

      - name: Keep Alive
        run: |
          Write-Host "Connect via RustDesk"
          Write-Host "ID: $env:ID"
          Write-Host "Password: $env:PASSWORD"
          while ($true) {
            Start-Sleep -Seconds 300
          }
